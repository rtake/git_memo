# Git - リモート操作の基本知識
Created 2023.01.27 by rtake

<br>

## 目次
1. [はじめに](#anchor1)
2. [これだけ押さえれば大丈夫 - clone/push/pull](#anchor2)
3. [少し詳しいGitの仕組み - 「追跡」を理解するためのTips](#anchor3)
4. [リモート操作のお困りごとと解消法](#anchor4)

<a id="anchor1"></a>

## 1. はじめに
### これは何？
* Git初心者(私)が、Gitのリモート操作を理解するために勉強した内容をまとめたものです。
* 基本的には公式ドキュメントを読んでいただくのが最も詳細かつ正確ですが、ドキュメントで難しい部分について、ネット上の参考記事をまとめたり、理解を助けるために自分なりの解釈を加えたものです。
    * [公式ドキュメント:リモートでの作業](https://git-scm.com/book/ja/v2/Git-%E3%81%AE%E5%9F%BA%E6%9C%AC-%E3%83%AA%E3%83%A2%E3%83%BC%E3%83%88%E3%81%A7%E3%81%AE%E4%BD%9C%E6%A5%AD)
    * [公式ドキュメント:リモートブランチ](https://git-scm.com/book/ja/v2/Git-%E3%81%AE%E3%83%96%E3%83%A9%E3%83%B3%E3%83%81%E6%A9%9F%E8%83%BD-%E3%83%AA%E3%83%A2%E3%83%BC%E3%83%88%E3%83%96%E3%83%A9%E3%83%B3%E3%83%81)
* 不確かな部分については[要出典]と記載していますのでご注意ください。(今後追記修正予定です)

<br>

### 対象読者と読み方
* `git commit` や `git add` などの基本操作を知っていれば読み進めることができます。
* リモート操作を活用した開発が初めての方は [これだけ押さえれば大丈夫 - clone/push/pull](#anchor2) を参照いただければ、基本的な操作には困らないはずです。
* 開発を進めていく中で困ったことが起きた場合には、Gitのもう少し詳細な仕組みを知っておくと対処しやすいことがあります。[少し詳しいGitの仕組み - 「追跡」を理解するためのTips](#anchor3) では入門レベルから一歩踏み込み、Gitの仕組みやリモート操作の中で何が行われているのかを説明しています。
* 実際に起こりうるお困りごとについては [リモート操作のお困りごとと解消法](#anchor4) にまとめてあります。今後も拡充予定です。

<br>

<a id="anchor2"></a>

## 2. これだけ押さえれば大丈夫 - clone/push/pull
リモート操作を活用した開発では、ローカル環境にリモートリポジトリを複製後、ローカルでの作業をコミットし、リモートリポジトリにコミットを反映する、という流れで開発が進んでいきます。必要に応じて、他メンバーの変更箇所をローカルに反映するための操作を行います。

<br>

### リモートリポジトリの複製 - clone
* 自分の環境で作業できるように、リモートリポジトリをローカルに複製します。
* コマンド: ``` git clone <リモートリポジトリのURL>``` 

<br>

### ローカルの変更をリモートに反映する - push
* ローカルで作業した内容(コミット)を他メンバーが参照できるようにリモートに反映します。
* コマンド: ``` git push <リモートリポジトリ名> <リモートリポジトリのブランチ名> ``` 
    * リモートリポジトリ名はデフォルトで ``` origin``` になるので、``` git push origin <ブランチ名> ``` とすることが多い。
    * リモートリポジトリ名とリモートリポジトリのブランチ名は自動で設定されることが多いので、省略して ``` git push ``` だけでよい場合が多い。(逆に、``` git push ``` で怒られるときはリポジトリとブランチが正しく設定されているのかを確認する必要がある)
* ローカルで作成したブランチをリモートリポジトリに登録したいときは [こちら](#anchor5)
* 手動でダウンロードしたコードをリモートリポジトリに登録したいときは [こちら](#anchor6)

<br>

### リモートリポジトリの最新版を自分の環境に取り込む - pull
* 他のメンバーによってリモートリポジトリが更新された場合に、その変更を自分のローカルにあるブランチに反映することが必要になります。
* コマンド: ``` git pull [リモートリポジトリ名> <リモートリポジトリのブランチ名> ```
    * pushのときと同じ理由で ``` git pull ``` でよい場合が多い。
* pullではリモートとローカルのブランチをマージするため、競合(コンフリクト)が発生する場合があります。コンフリクト解消の方法はこのドキュメントでは触れません。[こちら](https://www.r-staffing.co.jp/engineer/entry/20190927_1) などを参照にして対処してください。

<br>

<a id="anchor3"></a>

## 3. 少し詳しいGitの仕組み -「追跡」を理解するためのTips
Gitのリモート操作では　**リモート追跡ブランチ(Remote-tracking branches)** を理解することが重要です。

<br>

### リモートリポジトリって何？
* サーバ上に存在するリポジトリのこと。GitHubやAzure DevOpsなどを使う人が多い。自分のサーバに作成することもできる。(https://webbibouroku.com/Blog/Article/git-local-remote-repo#outline__2_1)
* リモートリポジトリのブランチ(リモートブランチ)にコミットするためには、ローカルリポジトリのブランチにリモートブランチを対応付ける必要がある。ローカル環境でリモートブランチを直接操作することはできない[要出典]。
* ローカルブランチとリモートブランチは **リモート追跡ブランチ** を介してつながっている。

<br>

### リモート追跡ブランチって何？
* ローカルリポジトリに存在し、リモートブランチに対応付けられているブランチのこと。(リモートブランチを追跡**する**ブランチ)

> リモート追跡ブランチは、リモートブランチの状態を保持する参照です。 ローカルに作成される参照ですが、自分で移動することはできません。ネットワーク越しの操作をしたときに自動的に移動します。 リモート追跡ブランチは、前回リモートリポジトリに接続したときにブランチがどの場所を指していたかを示すブックマークのようなものです。[3.5 Git のブランチ機能 - リモートブランチ](https://git-scm.com/book/ja/v2/Git-%E3%81%AE%E3%83%96%E3%83%A9%E3%83%B3%E3%83%81%E6%A9%9F%E8%83%BD-%E3%83%AA%E3%83%A2%E3%83%BC%E3%83%88%E3%83%96%E3%83%A9%E3%83%B3%E3%83%81)

* https://qiita.com/uasi/items/69368c17c79e99aaddbf の図がわかりやすい。
* ローカルブランチがリモート追跡ブランチを追跡するように設定することで、リモートブランチとローカルブランチを対応付けることができる。
    * ``` git branch -u <remotename>/<branch> ``` で、今いるブランチに追跡対象のリモート追跡ブランチを設定できる。

<br>

### リモート操作においてリモート追跡ブランチはどのようにはたらくのか
* pullやfetchは、リモート追跡ブランチを介してローカル/リモートブランチの状態を更新する。
    * ``` git fetch ``` では、**リモート追跡ブランチをリモートブランチの最新版に更新**する。
    * ``` git pull ``` では、``` git fetch ``` の後に **ローカルブランチにリモート追跡ブランチをマージ**する。
        * [【初心者向け】git fetch、git merge、git pullの違いについて](https://qiita.com/wann/items/688bc17460a457104d7d)

<br>

<a id="anchor4"></a>

## リモート操作のお困りごとと解消法
### git pullしたのに、リモートの変更がローカルに反映されない
1. まずは ``` git branch -a ``` で、目的のリモートブランチを追跡するリモート追跡ブランチがあるか確認する。
    * リモートブランチを追跡できていない場合は、``` git fetch ``` でリモート追跡ブランチを作成する。
2. ``` git branch -vv ``` で、ローカルブランチがリモート/リモート追跡ブランチを追跡できているか確認する。
    * 追跡できてない場合は、ローカルリポジトリで対象のブランチに移動し ``` git branch -u <remotename>/<branch> ``` とする。
        * ``` <remotename>/<branch> ``` はリモート追跡ブランチ。
3. ``` git fetch ``` でリモート追跡ブランチを最新のリモートブランチに更新する。
4. ``` git pull ``` すれば最新版のリモートブランチが反映される[要出典]。
    * ここはリモート追跡ブランチをローカルブランチにmergeするだけでもいい(3でfetchしているため)

<br>


### リモートブランチからローカルブランチを作りたい(checkoutしたい) 
* ``` git checkout -b <local_branch_name> <origin/remote_branch_name> ```
    * 参考: https://qiita.com/YusukeSuzuki@github/items/3bd5752783fd2c2f8805

<br>

### いまいるローカルブランチに、追跡させるリモートブランチを設定したい
* ``` git branch -u <remotename>/<branch> ```
* または ``` git push -u remote branch ```

<br>
<a id="anchor5"></a>

### ローカルでブランチを新たに作成し、そのブランチをリモートリポジトリに登録したい
*  ``` git push <リモートリポジトリ名> <ローカルのブランチ名>:<リモートで新たに作成したいブランチ名> ``` とします。
    * 普通にpushすると、"error: src refspec <ブランチ名> does not match any"と怒られる。
        * [gitをpushする際にエラー発生(error: src refspec ブランチ名 does not match any)](https://qiita.com/kenkono/items/c488ec9559f6cca34313)
        * [【Git】push時に生じる error:refspec src ... does not match any とは何なのか？](https://qiita.com/rtake/items/e9b8a45efbdc8b997e07)
    * ``` git push [リモートリポジトリ名] HEAD:[リモートで新たに作成したいブランチ> ``` でも大丈夫。
        * [Why use "HEAD:master" instead of just "master" in a "git push origin"](https://stackoverflow.com/questions/51909540/why-use-headmaster-instead-of-just-master-in-a-git-push-origin)

<br>
<a id="anchor6"></a>

### 手動でダウンロードしたコードをリモートリポジトリにpushしたい
* ローカルのブランチにリモートの情報を追加します。 
    * コマンド: ``` git remote add [リモートリポジトリの名前> <ブランチ名> ```
    * リモートリポジトリの名前は ``` origin ``` がデフォルトなので、``` git remote add origin [ブランチ名]``` とすることが多いです。
* リモートリポジトリにローカルの変更を反映します。
    * コマンド: ``` git push --set-upstream [リモートリポジトリ名> <ブランチ名> ```
    * ``` git remote add ``` だけではローカルブランチとリモートリポジトリ上のブランチは連携されないので、``` --set-upstream ``` としています。詳しくは [少し詳しいGitの仕組み:追跡ブランチを中心に](#anchor3) をご覧ください。
* 以降は ``` git push ``` だけでリモートにアップロードできます。
